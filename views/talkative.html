<!DOCTYPE html>
<html>
<head>
  <title>TalkativeJS</title>
  <script src="face-api.js"></script>
  <script src="faceTracker.js"></script>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/css/materialize.css">
  <script type="text/javascript"
          src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/js/materialize.min.js"></script>
  <script src="/reload/reload.js"></script>
</head>
<body>
<div id="navbar"></div>
<div class="center-content page-container">

  <div class="progress" id="loader">
    <div class="indeterminate"></div>
  </div>
  <div style="position: relative">
    <video onloadedmetadata="onPlay(this)" id="inputVideo" autoplay
           muted></video>
    <canvas id="overlay"/>
  </div>

  <div class="row side-by-side">

    <!-- fps_meter -->
    <div id="fps_meter" class="row side-by-side">
      <div>
        <label for="time">Time:</label>
        <input disabled value="-" id="time" type="text" class="bold">
        <label for="fps">Estimated Fps:</label>
        <input disabled value="-" id="fps" type="text" class="bold">
      </div>
    </div>
    <!-- fps_meter -->

  </div>

  <!-- ssd_mobilenetv1_controls -->
  <span id="ssd_mobilenetv1_controls">
      <div class="row side-by-side">
        <div class="row">
          <label for="minConfidence">Min Confidence:</label>
          <input disabled value="0.5" id="minConfidence" type="text"
                 class="bold">
        </div>
        <button
          class="waves-effect waves-light btn"
          onclick="onDecreaseMinConfidence()"
        >
          <i class="material-icons left">-</i>
        </button>
        <button
          class="waves-effect waves-light btn"
          onclick="onIncreaseMinConfidence()"
        >
          <i class="material-icons left">+</i>
        </button>
      </div>
    </span>
  <!-- ssd_mobilenetv1_controls -->

</div>

<script>
  let forwardTimes = [];

  function updateTimeStats(timeInMs) {
    forwardTimes = [timeInMs].concat(forwardTimes).slice(0, 30);
    const avgTimeInMs = forwardTimes.reduce((total, t) => total + t) / forwardTimes.length;
    $('#time').val(`${Math.round(avgTimeInMs)} ms`);
    $('#fps').val(`${faceapi.round(1000 / avgTimeInMs)}`)
  }

  async function onPlay() {
    const videoEl = $('#inputVideo').get(0);

    if (videoEl.paused || videoEl.ended || !isFaceDetectionModelLoaded())
      return setTimeout(() => onPlay());


    const options = getFaceDetectorOptions();

    const ts = Date.now();

    const result = await faceapi.detectAllFaces(videoEl, options);

    updateTimeStats(Date.now() - ts);

    if (result && result.length > 0) {
      const canvas = $('#overlay').get(0);
      const dims = faceapi.matchDimensions(canvas, videoEl, true);
      faceapi.draw.drawDetections(canvas, faceapi.resizeResults(result, dims))
      var ctx = canvas.getContext('2d');
      drawBubble(ctx, result[0]._box._x, result[0]._box._y, 100, 90, 20);
    }

    setTimeout(() => onPlay())
  }

  async function run() {
    // load face detection model
    await changeFaceDetector(SSD_MOBILENETV1);

    // try to access users webcam and stream the images
    // to the video element
    const stream = await navigator.mediaDevices.getUserMedia({
      video: {
        width: 1920,
        height: 1080
      }
    });
    const videoEl = $('#inputVideo').get(0);
    videoEl.srcObject = stream
  }

  function updateResults() {
  }

  function drawBubble(ctx, x, y, w, h, radius) {
    var r = x + w;
    var b = y + h;
    ctx.beginPath();
    ctx.strokeStyle="black";
    ctx.lineWidth="2";    y = y - h;
    ctx.moveTo(x+radius, y);
    ctx.lineTo(r-radius, y);
    ctx.quadraticCurveTo(r, y, r, y+radius);
    ctx.lineTo(r, y+h-radius);
    ctx.quadraticCurveTo(r, b, r-radius, b);
    ctx.lineTo(r+20, b+40);
    ctx.lineTo(r-50, b);
    ctx.lineTo(x+radius, b);
    ctx.quadraticCurveTo(x, b, x, b-radius);
    ctx.lineTo(x, y+radius);
    ctx.quadraticCurveTo(x, y, x+radius, y);
    ctx.stroke();
  }

  $(document).ready(function () {
    run()
  })
</script>
</body>
</html>
